package cmd

import (
	"fmt"
	"os"
	"path/filepath"
	"syscall"

	"github.com/spf13/cobra"
)

func init() { rootCmd.AddCommand(useCmd) }

var useCmd = &cobra.Command{
	Use:   "use [name]",
	Short: "Switch to a profile",
	Args:  cobra.ExactArgs(1),
	RunE: func(cmd *cobra.Command, args []string) error {
		name := args[0]

		// üö´ N·∫øu ƒëang trong subshell, ch·∫∑n ƒë·ªïi profile
		if os.Getenv("SCTX_ACTIVE") == "1" {
			current := os.Getenv("SCTX_PROFILE")
			fmt.Printf("‚ö†Ô∏è  You are currently inside profile %q.\n", current)
			fmt.Println("üëâ Please type 'exit' to leave the subshell before switching to another profile.")
			return nil
		}

		home, _ := os.UserHomeDir()
		profileDir := filepath.Join(home, ".sctx", "profiles")
		profilePath := filepath.Join(profileDir, name)

		if _, err := os.Stat(profilePath); os.IsNotExist(err) {
			return fmt.Errorf("profile %q not found in %s", name, profileDir)
		}

		currentFile := filepath.Join(home, ".sctx", "current")
		if err := os.MkdirAll(filepath.Dir(currentFile), 0o755); err != nil {
			return err
		}

		if err := os.WriteFile(currentFile, []byte(name), 0o644); err != nil {
			return err
		}

		fmt.Printf("‚úÖ switched to profile: %s\n", name)

		shell := os.Getenv("SHELL")
		if shell == "" {
			shell = "/bin/zsh"
		}

		// üîß T·∫°o th∆∞ m·ª•c t·∫°m cho ZDOTDIR
		tempDir, err := os.MkdirTemp("", fmt.Sprintf("sctx-%s-*", name))
		if err != nil {
			return fmt.Errorf("failed to create temp dir: %w", err)
		}
		defer os.RemoveAll(tempDir)

		zshrcPath := filepath.Join(tempDir, ".zshrc")

		script := fmt.Sprintf(`# ~/.zshrc generated by sctx
export SCTX_PROFILE=%s
export SCTX_ACTIVE=1

# Source user's original .zshrc n·∫øu c√≥
if [[ -f "$HOME/.zshrc" ]]; then
  source "$HOME/.zshrc"
fi

# Hi·ªÉn th·ªã prefix m√†u ƒë·ªè
red=$'\033[1;31m'
reset=$'\033[0m'
PROMPT="[$red$SCTX_PROFILE$reset] %%n@%%m %%1~ %%# "
setopt PROMPT_SUBST

# Load profile th·ª±c t·∫ø c·ªßa sctx
if [[ -f "%s" ]]; then
  source "%s"
fi

# Hook exit hi·ªÉn th·ªã log
function exit() {
  echo "üëã Leaving profile: $SCTX_PROFILE"
  builtin exit
}
`, name, profilePath, profilePath)

		if err := os.WriteFile(zshrcPath, []byte(script), 0o644); err != nil {
			return fmt.Errorf("failed to write zshrc: %w", err)
		}

		env := append(os.Environ(), fmt.Sprintf("ZDOTDIR=%s", tempDir))

		// ‚öôÔ∏è Thay th·∫ø process hi·ªán t·∫°i b·∫±ng zsh
		fmt.Printf("\033]0;[%s] sctx\007", name)
		fmt.Printf("\033[1;31m[%s]\033[0m subshell started. Type 'exit' to leave.\n", name)

		return syscall.Exec(shell, []string{shell}, env)
	},
}
